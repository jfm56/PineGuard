<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PineGuard - Wildfire Risk Prediction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <style>
        #map { 
            height: 600px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid #ddd;
            position: relative;
        }
        
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            margin: 10px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .mapboxgl-canvas {
            outline: none;
        }
        .alert {
            margin: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        .alert-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        /* Risk levels */
        .risk-high { background-color: #dc3545; color: white; }
        .risk-moderate { background-color: #ffc107; color: black; }
        .risk-low { background-color: #28a745; color: white; }

        /* Progress bars */
        .progress-list .factor-item { margin-bottom: 10px; }
        .progress { height: 20px; background-color: #f8f9fa; }
        .progress-bar { transition: width 0.6s ease; }
        .bg-danger { background-color: #dc3545 !important; }
        .bg-warning { background-color: #ffc107 !important; }
        .bg-success { background-color: #28a745 !important; }

        /* Recommendations */
        .recommendation-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .recommendation-card.high { border-left: 4px solid #dc3545; }
        .recommendation-card.medium { border-left: 4px solid #ffc107; }
        .recommendation-card.low { border-left: 4px solid #28a745; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">PineGuard</a>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-9">
                <div id="map">
                    <div class="map-loading">
                        <div class="loading-spinner"></div>
                        <p>Loading map...</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Risk Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div id="risk-info">
                            <p>Select an area on the map to analyze wildfire risk.</p>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">High Risk Regions</h5>
                    </div>
                    <div class="card-body">
                        <div id="regions-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script>
        // Check if Mapbox GL JS is available
        if (typeof mapboxgl === 'undefined') {
            console.error('Mapbox GL JS not loaded');
            document.getElementById('map').innerHTML = `
                <div class="alert alert-danger">
                    <h5>Map Library Not Loaded</h5>
                    <p>Unable to load the map library. Please check your internet connection.</p>
                </div>
            `;
        }

        function getColorClass(value) {
            if (value >= 0.7) return 'danger';
            if (value >= 0.4) return 'warning';
            return 'success';
        }

        function getPriorityColor(priority) {
            switch(priority.toLowerCase()) {
                case 'high': return 'danger';
                case 'medium': return 'warning';
                case 'low': return 'success';
                default: return 'secondary';
            }
        }
        // Initialize map
        console.log('Initializing map...');
        // Default public demo token
        const defaultToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
        mapboxgl.accessToken = defaultToken;
        
        let map;
        try {
            console.log('Creating map with Mapbox GL JS version:', mapboxgl.version);
            map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/navigation-day-v1',
            center: [-74.5, 39.8],
            zoom: 9,
            maxBounds: [[-75.5, 38.8], [-73.5, 40.8]] // Restrict to NJ Pinelands area
        });

        map.on('load', () => {
            console.log('Map loaded successfully');
            // Remove loading state
            const loadingElement = document.querySelector('.map-loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        });

        // Test map access
        fetch(`https://api.mapbox.com/v4/mapbox.satellite/0/0/0.png?access_token=${defaultToken}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Map access failed');
            }
            console.log('Mapbox access validated successfully');
        })
        .catch(error => {
            console.error('Token validation error:', error);
            const mapElement = document.getElementById('map');
            const loadingElement = mapElement.querySelector('.map-loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            mapElement.innerHTML = `
                <div class="alert alert-danger">
                    <h5>Map Access Error</h5>
                    <p>Unable to validate map access. Please check your connection or contact support.</p>
                    <button class="btn btn-outline-danger btn-sm mt-2" onclick="window.location.reload()">Try Again</button>
                </div>
            `;
        });

        map.on('error', (e) => {
            console.error('Map error details:', {
                message: e.error ? e.error.message : 'Unknown error',
                status: e.status,
                type: e.type
            });
            const mapElement = document.getElementById('map');
            const loadingElement = mapElement.querySelector('.map-loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            mapElement.innerHTML = `
                <div class="alert alert-danger">
                    <h5>Map Error</h5>
                    <p>${e.error ? e.error.message : 'An unknown error occurred'}</p>
                    <small>Please check console for more details.</small>
                    <button class="btn btn-outline-danger btn-sm mt-2" onclick="window.location.reload()">Try Again</button>
                </div>
            `;
        });

        // Wait for map style to load
        map.on('style.load', () => {
            console.log('Map style loaded successfully');
            
            // Add terrain
            map.addSource('mapbox-dem', {
                'type': 'raster-dem',
                'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                'tileSize': 512,
                'maxzoom': 14
            });
            
            // Add sky layer
            map.addLayer({
                'id': 'sky',
                'type': 'sky',
                'paint': {
                    'sky-type': 'atmosphere',
                    'sky-atmosphere-sun': [0.0, 90.0],
                    'sky-atmosphere-sun-intensity': 15
                }
            });

            // Enable terrain
            map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });

            // Add 3D buildings
            map.addLayer({
                'id': '3d-buildings',
                'source': 'composite',
                'source-layer': 'building',
                'filter': ['==', 'extrude', 'true'],
                'type': 'fill-extrusion',
                'minzoom': 15,
                'paint': {
                    'fill-extrusion-color': '#aaa',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': .6
                }
            });
        });

        // Add map controls
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        map.addControl(new mapboxgl.ScaleControl(), 'bottom-right');
        map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
        
        // Add terrain control
        map.addControl(
            new mapboxgl.TerrainControl({
                source: 'mapbox-dem',
                exaggeration: 1.5
            })
        );

        // Load regions
        fetch('/api/v1/regions')
            .then(response => response.json())
            .then(data => {
                const regionsList = document.getElementById('regions-list');
                data.regions.forEach(region => {
                    const div = document.createElement('div');
                    div.className = `alert risk-${region.risk_level}`;
                    div.textContent = region.name;
                    div.style.cursor = 'pointer';
                    div.onclick = () => {
                        map.flyTo({
                            center: region.center,
                            zoom: 12
                        });
                    };
                    regionsList.appendChild(div);
                });
            });

        // Handle map clicks
        map.on('click', (e) => {
            console.log('Map clicked at:', e.lngLat);
            const coordinates = [
                [e.lngLat.lng - 0.1, e.lngLat.lat - 0.1],
                [e.lngLat.lng + 0.1, e.lngLat.lat + 0.1]
            ];

            fetch('/api/v1/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    coordinates: coordinates
                })
            })
            .then(response => response.json())
            .then(data => {
                const riskInfo = document.getElementById('risk-info');
                riskInfo.innerHTML = `
                    <h6>Risk Analysis Results</h6>
                    <p>Risk Score: <strong>${(data.risk_score * 100).toFixed(1)}%</strong></p>
                    <p>Confidence: ${(data.confidence * 100).toFixed(1)}%</p>
                    
                    <h6 class="mt-4">Environmental Factors</h6>
                    <div class="progress-list">
                        ${Object.entries(data.environmental_factors).map(([factor, value]) => `
                            <div class="factor-item">
                                <label>${factor.charAt(0).toUpperCase() + factor.slice(1)}</label>
                                <div class="progress">
                                    <div class="progress-bar bg-${getColorClass(value)}" 
                                         role="progressbar" 
                                         style="width: ${(value * 100)}%">
                                        ${(value * 100).toFixed(0)}%
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <h6 class="mt-4">Historical Data</h6>
                    <p>Fire Frequency: ${(data.historical_data.fire_frequency * 100).toFixed(1)}%</p>
                    <p>Seasonal Risk: ${(data.historical_data.seasonal_risk * 100).toFixed(1)}%</p>
                    <h6>Previous Fires:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Size (ha)</th>
                                    <th>Cause</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.historical_data.previous_fires.map(fire => `
                                    <tr>
                                        <td>${fire.year}</td>
                                        <td>${fire.size_hectares}</td>
                                        <td>${fire.cause}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <h6 class="mt-4">Infrastructure Risk</h6>
                    <div class="progress-list">
                        ${Object.entries(data.infrastructure_risk).map(([factor, value]) => `
                            <div class="factor-item">
                                <label>${factor.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}</label>
                                <div class="progress">
                                    <div class="progress-bar bg-${getColorClass(value)}" 
                                         role="progressbar" 
                                         style="width: ${(value * 100)}%">
                                        ${(value * 100).toFixed(0)}%
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <h6 class="mt-4">Mitigation Recommendations</h6>
                    ${data.mitigation_recommendations.map(rec => `
                        <div class="recommendation-card ${rec.priority}">
                            <h6>${rec.action}</h6>
                            <p>Priority: <span class="badge bg-${getPriorityColor(rec.priority)}">${rec.priority}</span></p>
                            <p>Estimated Cost: $${rec.estimated_cost.toLocaleString()}</p>
                            <p>Time Frame: ${rec.time_frame}</p>
                        </div>
                    `).join('')}

                    <small class="text-muted mt-3 d-block">Last updated: ${new Date(data.timestamp).toLocaleString()}</small>
                `;
            });
        });
        } catch (error) {
            console.error('Error initializing map:', {
                message: error.message,
                stack: error.stack
            });
            document.getElementById('map').innerHTML = `
                <div class="alert alert-danger">
                    <h5>Error initializing map</h5>
                    <p>${error.message}</p>
                    <small>Please check console for more details.</small>
                </div>
            `;
        }
    </script>
</body>
</html>
